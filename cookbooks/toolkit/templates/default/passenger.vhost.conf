<VirtualHost *:80>
    ServerAdmin info@cyclestreets.net

    ServerName www.cyclescape.org
    ServerAlias cyclescape.org *.cyclescape.org
    ServerAlias cyclescape.net *.cyclescape.net
    ServerAlias cyclescape.com *.cyclescape.com
    ServerAlias cyclescape.org.uk *.cyclescape.org.uk

    RewriteEngine on

    # If the host doesn't end in the .org version, redirect

    RewriteCond %{HTTP_HOST} !cyclescape.org$ [NC]
    RewriteRule ^/(.*) http://www.cyclescape.org/$1 [L,R]

    # If the host is exactly cyclescape.org, redirect to www
    # This avoids messing up placeford.cyclescape.org

    RewriteCond %{HTTP_HOST} ^cyclescape.org$ [NC]
    RewriteRule ^/(.*) http://www.cyclescape.org/$1 [L,R]

    # for e.g. www.placeford.cyclescape.org, strip the www

    RewriteCond %{HTTP_HOST} ^www\.(.+)\.cyclescape.org$ [NC]
    RewriteRule ^/(.*) http://%1.cyclescape.org/$1 [L,R]

    AddExternalAuth pwauth /usr/sbin/pwauth
    SetExternalAuthMethod pwauth pipe

    DocumentRoot /var/www/toolkit/current/public
    <Directory /var/www/toolkit/current/public>
        AllowOverride all
        Options -MultiViews

        AuthType Basic
        AuthName "Beta Testing"
        AuthBasicProvider external
        AuthExternal pwauth
        require valid-user
    </Directory>

    RailsEnv production
</VirtualHost>
